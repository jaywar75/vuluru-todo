<!-- templates/index.html -->

{% extends 'base.html' %}
{% block title %}vuluru{% endblock %}

{% block content %}
<h2 class="mb-3">Task Manager</h2>

<form method="GET" action="{{ url_for('index') }}" class="row g-3 mb-4 align-items-end">
  <div class="col-md-3">
    <label for="filter_status" class="form-label">Filter by Status</label>
    <select class="form-select" id="filter_status" name="filter_status">
      <option value="All" {% if filter_status == 'All' %}selected{% endif %}>All</option>
      <option value="Pending" {% if filter_status == 'Pending' %}selected{% endif %}>Pending</option>
      <option value="Completed" {% if filter_status == 'Completed' %}selected{% endif %}>Completed</option>
    </select>
  </div>
  <div class="col-md-3">
    <label for="sort_by" class="form-label">Sort by</label>
    <select class="form-select" id="sort_by" name="sort_by">
      <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Created At</option>
      <option value="due_date" {% if sort_by == 'due_date' %}selected{% endif %}>Due Date</option>
      <option value="priority" {% if sort_by == 'priority' %}selected{% endif %}>Priority</option>
    </select>
  </div>
  <div class="col-md-3">
    <label for="sort_order" class="form-label">Sort Order</label>
    <select class="form-select" id="sort_order" name="sort_order">
      <option value="Ascending" {% if sort_order == 'Ascending' %}selected{% endif %}>Ascending</option>
      <option value="Descending" {% if sort_order == 'Descending' %}selected{% endif %}>Descending</option>
    </select>
  </div>
  <div class="col-md-3 d-flex gap-2 justify-content-end">
    <!-- Icon-only “Apply” button with tooltip -->
    <button type="submit"
            class="btn btn-primary"
            data-bs-toggle="tooltip"
            title="Apply">
      <i class="bi bi-filter-circle"></i>
    </button>

    <!-- Icon-only “Add Task” button with tooltip -->
    <a href="{{ url_for('add_task') }}"
       class="btn btn-success"
       data-bs-toggle="tooltip"
       title="Add New Task">
      <i class="bi bi-plus-circle"></i>
    </a>
  </div>
</form>

<div class="table-responsive">
  <table class="table table-dark table-hover align-middle">
    <thead>
      <tr>
        <!-- Removed the “ID” column. -->
        <th>Description</th>
        <th>Status</th>
        <th>Due Date</th>
        <th>Priority</th>
        <th>Created At</th>
        <th class="text-center">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for task in tasks %}
      <tr>
        <!-- No `_id` field displayed here. -->
        <td>{{ task.description }}</td>
        <td>
          {% if task.status == 'Completed' %}
            <span class="badge bg-success">{{ task.status }}</span>
          {% else %}
            <span class="badge bg-warning text-dark">{{ task.status }}</span>
          {% endif %}
        </td>
        <td>{{ task.due_date if task.due_date else 'N/A' }}</td>
        <td>
          {% if task.priority == 'High' %}
            <span class="badge bg-danger" data-bs-toggle="tooltip" title="High Priority">
              {{ task.priority }}
            </span>
          {% elif task.priority == 'Medium' %}
            <span class="badge bg-warning text-dark" data-bs-toggle="tooltip" title="Medium Priority">
              {{ task.priority }}
            </span>
          {% elif task.priority == 'Low' %}
            <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Low Priority">
              {{ task.priority }}
            </span>
          {% else %}
            <span class="badge bg-light text-dark">N/A</span>
          {% endif %}
        </td>
        <td>{{ task.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</td>
        <td class="text-center">
          <!-- Mark as Completed (if not yet done) -->
          {% if task.status != 'Completed' %}
          <form action="{{ url_for('complete_task_route', task_id=task._id) }}" 
                method="POST" style="display:inline;">
            <button type="submit" class="btn btn-sm btn-primary me-1" 
                    data-bs-toggle="tooltip" 
                    title="Mark as Completed">
              <i class="bi bi-check-circle"></i>
            </button>
          </form>
          {% endif %}

          <!-- Edit Task button: link to edit_task route -->
          <a href="{{ url_for('edit_task', task_id=task._id) }}"
             class="btn btn-sm btn-info me-1"
             data-bs-toggle="tooltip"
             title="Edit Task">
            <i class="bi bi-pencil-square"></i>
          </a>

          <!-- Remove Task button: triggers modal -->
          <button type="button" class="btn btn-sm btn-danger delete-btn"
                  data-task-id="{{ task._id }}"
                  data-bs-toggle="modal"
                  data-bs-target="#deleteTaskModal"
                  data-bs-toggle="tooltip"
                  title="Remove Task">
            <i class="bi bi-trash-fill"></i>
          </button>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="6" class="text-center">No tasks found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="deleteTaskForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteTaskModalLabel">Confirm Task Removal</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to remove this task?
          <input type="hidden" name="task_id" id="delete_task_id" value="">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Yes, Remove</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}